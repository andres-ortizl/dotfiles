name: lab

networks:
  traefik:
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.0.0/24
  pihole_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.31.0.0/16

volumes:
  model-cache:
  immich-db:
  immich-redis:
  linkstack-data:
  dockhand-data:
  memos-data:
  dokploy-postgres:
  dokploy-redis:
  dokploy-data:
  tailscale-data:

services:
  # Traefik Reverse Proxy
  traefik:
    image: traefik:v3.5.4
    container_name: traefik
    restart: unless-stopped
    ports:
      - "80:80" # HTTP
      - "443:443" # HTTPS
      - "9090:8080" # Traefik dashboard on port 9090
    command:
      - --api.dashboard=true
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.dashboard.entrypoints=web"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard-secure.rule=Host(`traefik.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.dashboard-secure.entrypoints=websecure"
      - "traefik.http.routers.dashboard-secure.tls=true"
      - "traefik.http.routers.dashboard-secure.service=api@internal"

  # Homepage Dashboard
  dashy:
    image: lissy93/dashy:latest
    container_name: dashy
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - UID=${PUID:-1000}
      - GID=${PGID:-1000}
      - VUE_APP_WEATHER_API_KEY=${WEATHER_API_KEY:-}
      - VUE_APP_PIHOLE_API_KEY=${PIHOLE_PASSWORD:-admin}
      - VUE_APP_RSS_API_KEY=${RSS_API_KEY:-}
    volumes:
      - ./dashy/conf.yml:/app/user-data/conf.yml
    networks:
      - traefik
    healthcheck:
      test: ["CMD", "node", "/app/services/healthcheck"]
      interval: 1m30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "traefik.enable=true"
      - "com.centurylinklabs.watchtower.enable=true"
      - "traefik.http.routers.dashy.rule=Host(`home.${DOMAIN:-localhost}`) || Host(`${DOMAIN:-localhost}`)"
      - "traefik.http.routers.dashy.entrypoints=web"
      - "traefik.http.routers.dashy-secure.rule=Host(`home.${DOMAIN:-localhost}`) || Host(`${DOMAIN:-localhost}`)"
      - "traefik.http.routers.dashy-secure.entrypoints=websecure"
      - "traefik.http.routers.dashy-secure.tls=true"
      - "traefik.http.services.dashy.loadbalancer.server.port=8080"

  # Dockhand - Docker Management UI
  dockhand:
    image: fnsys/dockhand:latest
    container_name: dockhand
    restart: unless-stopped
    environment:
      - TZ=${TZ:-Europe/Madrid}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - dockhand-data:/data
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "com.centurylinklabs.watchtower.enable=true"
      - "traefik.http.routers.dockhand.rule=Host(`docker.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.dockhand.entrypoints=web"
      - "traefik.http.routers.dockhand-secure.rule=Host(`docker.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.dockhand-secure.entrypoints=websecure"
      - "traefik.http.routers.dockhand-secure.tls=true"
      - "traefik.http.services.dockhand.loadbalancer.server.port=3000"

  # Watchtower Auto-updater (only updates containers with watchtower.enable=true label)
  watchtower:
    image: nickfedor/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_REMOVE_VOLUMES=false
      - WATCHTOWER_INCLUDE_STOPPED=true
      - WATCHTOWER_LABEL_ENABLE=true
      - WATCHTOWER_SCHEDULE=0 0 4 * * *
      - TZ=${TZ:-Europe/Madrid}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - traefik

  # Tailscale - VPN Access
  tailscale:
    image: tailscale/tailscale:latest
    container_name: tailscale
    hostname: homeserver
    restart: unless-stopped
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
      - TS_ROUTES=172.18.0.0/24,172.31.0.0/16,192.168.1.0/24
      - TS_ACCEPT_DNS=false
    volumes:
      - tailscale-data:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    networks:
      - traefik
      - pihole_network

  # Sync Service - Configuration Sync UI
  sync-service:
    build: ./sync-service
    container_name: sync-service
    restart: unless-stopped
    environment:
      - TZ=${TZ:-Europe/Madrid}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ../../../dotfiles:/dotfiles
      - ./sync-service/data:/app/data
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "com.centurylinklabs.watchtower.enable=true"
      - "traefik.http.routers.sync-service.rule=Host(`sync.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.sync-service.entrypoints=web"
      - "traefik.http.routers.sync-service-secure.rule=Host(`sync.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.sync-service-secure.entrypoints=websecure"
      - "traefik.http.routers.sync-service-secure.tls=true"
      - "traefik.http.services.sync-service.loadbalancer.server.port=8000"

  # PostgreSQL for Dokploy
  dokploy-postgres:
    image: postgres:15-alpine
    container_name: dokploy-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=dokploy
      - POSTGRES_PASSWORD=${DOKPLOY_DB_PASSWORD:-dokploy_password_123}
      - POSTGRES_DB=dokploy
    volumes:
      - dokploy-postgres:/var/lib/postgresql/data
    networks:
      - traefik
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dokploy"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Redis for Dokploy
  dokploy-redis:
    image: redis:7-alpine
    container_name: dokploy-redis
    restart: unless-stopped
    volumes:
      - dokploy-redis:/data
    networks:
      - traefik
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Dokploy - Self-hosted PaaS
  dokploy:
    image: dokploy/dokploy:latest
    container_name: dokploy
    restart: unless-stopped
    depends_on:
      dokploy-postgres:
        condition: service_healthy
      dokploy-redis:
        condition: service_healthy
    environment:
      - DATABASE_URL=postgresql://dokploy:${DOKPLOY_DB_PASSWORD:-dokploy_password_123}@dokploy-postgres:5432/dokploy
      - REDIS_URL=redis://dokploy-redis:6379
      - SECRET_KEY=${DOKPLOY_SECRET_KEY:-change-this-to-a-random-secret-key}
      - TZ=${TZ:-Europe/Madrid}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - dokploy-data:/app/data
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "com.centurylinklabs.watchtower.enable=true"
      - "traefik.http.routers.dokploy.rule=Host(`deploy.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.dokploy.entrypoints=web"
      - "traefik.http.routers.dokploy-secure.rule=Host(`deploy.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.dokploy-secure.entrypoints=websecure"
      - "traefik.http.routers.dokploy-secure.tls=true"
      - "traefik.http.services.dokploy.loadbalancer.server.port=3000"

  # Pi-hole DNS Server
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    restart: unless-stopped
    environment:
      - TZ=${TZ:-Europe/Madrid}
      - WEBPASSWORD=${PIHOLE_PASSWORD:-admin}
      - PIHOLE_DNS_=${PIHOLE_DNS:-1.1.1.1;1.0.0.1}
      - DNSMASQ_LISTENING=all
      - DNSSEC=true
      - WEBTHEME=default-dark
      - VIRTUAL_HOST=pihole.${DOMAIN:-localhost}
      - PIHOLE_DOMAIN=${DOMAIN:-localhost}
    volumes:
      - ./pihole/etc-pihole:/etc/pihole
      - ./pihole/etc-dnsmasq.d:/etc/dnsmasq.d
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "3333:80"
    dns:
      - 127.0.0.1
      - 1.1.1.1
    cap_add:
      - NET_ADMIN
    networks:
      traefik: {}
      pihole_network:
        ipv4_address: "172.31.0.100"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pihole.rule=Host(`pihole.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.pihole.entrypoints=web"
      - "traefik.http.routers.pihole-secure.rule=Host(`pihole.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.pihole-secure.entrypoints=websecure"
      - "traefik.http.routers.pihole-secure.tls=true"
      - "traefik.http.services.pihole.loadbalancer.server.port=80"
      - "com.centurylinklabs.watchtower.enable=true"
      - "homepage.group=Network"
      - "homepage.name=Pi-hole"
      - "homepage.icon=pihole.png"
      - "homepage.href=http://pihole.${DOMAIN:-localhost}:3333/admin"
      - "homepage.description=Network-wide ad blocking and DNS"
      - "homepage.weight=1"
      - "homepage.widget.type=pihole"
      - "homepage.widget.url=http://pihole"
      - "homepage.widget.key=${PIHOLE_API_KEY:-}"

  # DHCP Helper for Pi-hole
  dhcphelper:
    image: noamokman/dhcp-helper
    container_name: dhcp-helper
    restart: unless-stopped
    network_mode: "host"
    command: -s 172.31.0.100
    cap_add:
      - NET_ADMIN

  # qBittorrent Download Client
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: unless-stopped
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/Madrid}
      - WEBUI_PORT=8080
    volumes:
      - ./qbittorrent/config:/config
      - ${DATA_ROOT:-./data}:/data
    ports:
      - "6881:6881"
      - "6881:6881/udp"
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "com.centurylinklabs.watchtower.enable=true"
      - "traefik.http.routers.qbittorrent.rule=Host(`qbittorrent.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.qbittorrent.entrypoints=web"
      - "traefik.http.routers.qbittorrent.service=qbittorrent"
      - "traefik.http.routers.qbittorrent-secure.rule=Host(`qbittorrent.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.qbittorrent-secure.entrypoints=websecure"
      - "traefik.http.routers.qbittorrent-secure.tls=true"
      - "traefik.http.routers.qbittorrent-secure.service=qbittorrent"
      - "traefik.http.services.qbittorrent.loadbalancer.server.port=8080"

  # Immich Photo Management
  immich-server:
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}
    container_name: immich_server
    restart: unless-stopped
    volumes:
      - ${UPLOAD_LOCATION:-./immich/upload}:/data
      - /etc/localtime:/etc/localtime:ro
      - /home/andrew/immich:/mnt/old-immich:ro
      - /home/andrew/immich-test:/mnt/immich-test:ro
    env_file:
      - .env
    depends_on:
      - redis
      - database
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "com.centurylinklabs.watchtower.enable=true"
      - "traefik.http.routers.immich.rule=Host(`immich.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.immich.entrypoints=web"
      - "traefik.http.routers.immich-secure.rule=Host(`immich.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.immich-secure.entrypoints=websecure"
      - "traefik.http.routers.immich-secure.tls=true"
      - "traefik.http.services.immich.loadbalancer.server.port=2283"
    healthcheck:
      disable: false

  # Immich Machine Learning
  immich-machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:release
    container_name: immich_machine_learning
    restart: unless-stopped
    volumes:
      - model-cache:/cache
    env_file:
      - .env
    networks:
      - traefik
    healthcheck:
      disable: false

  # Immich Redis Cache
  redis:
    image: docker.io/valkey/valkey:8-bookworm@sha256:fea8b3e67b15729d4bb70589eb03367bab9ad1ee89c876f54327fc7c6e618571
    container_name: immich_redis
    restart: unless-stopped
    volumes:
      - immich-redis:/data
    networks:
      - traefik
    healthcheck:
      test: redis-cli ping || exit 1

  # Immich PostgreSQL Database
  database:
    image: ghcr.io/immich-app/postgres:14-vectorchord0.4.3-pgvectors0.2.0@sha256:bcf63357191b76a916ae5eb93464d65c07511da41e3bf7a8416db519b40b1c23
    container_name: immich_postgres
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_USER: ${DB_USERNAME:-postgres}
      POSTGRES_DB: ${DB_DATABASE_NAME:-immich}
      POSTGRES_INITDB_ARGS: "--data-checksums"
    volumes:
      - immich-db:/var/lib/postgresql/data
    shm_size: 128mb
    networks:
      - traefik

  # Open WebUI for AI
  openwebui:
    image: ghcr.io/open-webui/open-webui:latest
    container_name: openwebui
    restart: unless-stopped
    environment:
      - TZ=${TZ:-Europe/Madrid}
    volumes:
      - ./openwebui/data:/app/backend/data
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "com.centurylinklabs.watchtower.enable=true"
      - "traefik.http.routers.openwebui.rule=Host(`chat.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.openwebui.entrypoints=web"
      - "traefik.http.routers.openwebui-secure.rule=Host(`chat.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.openwebui-secure.entrypoints=websecure"
      - "traefik.http.routers.openwebui-secure.tls=true"
      - "traefik.http.services.openwebui.loadbalancer.server.port=8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Excalidraw Collaborative Whiteboard
  excalidraw:
    image: excalidraw/excalidraw:latest
    container_name: excalidraw
    restart: unless-stopped
    environment:
      - TZ=${TZ:-Europe/Madrid}
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "com.centurylinklabs.watchtower.enable=true"
      - "traefik.http.routers.excalidraw.rule=Host(`excalidraw.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.excalidraw.entrypoints=web"
      - "traefik.http.routers.excalidraw-secure.rule=Host(`excalidraw.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.excalidraw-secure.entrypoints=websecure"
      - "traefik.http.routers.excalidraw-secure.tls=true"
      - "traefik.http.services.excalidraw.loadbalancer.server.port=80"

  # Uptime Kuma Monitoring
  uptime-kuma:
    image: louislam/uptime-kuma:2
    container_name: uptime-kuma
    restart: unless-stopped
    environment:
      - TZ=${TZ:-Europe/Madrid}
    volumes:
      - ./uptime-kuma:/app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "com.centurylinklabs.watchtower.enable=true"
      - "traefik.http.routers.uptime-kuma.rule=Host(`uptime.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.uptime-kuma.entrypoints=web"
      - "traefik.http.routers.uptime-kuma-secure.rule=Host(`uptime.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.uptime-kuma-secure.entrypoints=websecure"
      - "traefik.http.routers.uptime-kuma-secure.tls=true"
      - "traefik.http.services.uptime-kuma.loadbalancer.server.port=3001"

  # Dozzle - Real-time Log Viewer
  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "com.centurylinklabs.watchtower.enable=true"
      - "traefik.http.routers.dozzle.rule=Host(`logs.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.dozzle.entrypoints=web"
      - "traefik.http.routers.dozzle-secure.rule=Host(`logs.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.dozzle-secure.entrypoints=websecure"
      - "traefik.http.routers.dozzle-secure.tls=true"
      - "traefik.http.services.dozzle.loadbalancer.server.port=8080"

  # Memos - Note-taking Service
  memos:
    image: neosmemo/memos:stable
    container_name: memos
    restart: unless-stopped
    environment:
      - TZ=${TZ:-Europe/Madrid}
    volumes:
      - memos-data:/var/opt/memos
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "com.centurylinklabs.watchtower.enable=true"
      - "traefik.http.routers.memos.rule=Host(`memos.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.memos.entrypoints=web"
      - "traefik.http.routers.memos-secure.rule=Host(`memos.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.memos-secure.entrypoints=websecure"
      - "traefik.http.routers.memos-secure.tls=true"
      - "traefik.http.services.memos.loadbalancer.server.port=5230"

  # Cobalt - Web-based Media Downloader
  cobalt:
    image: dennysubke/cobalt:11.5
    container_name: cobalt
    restart: unless-stopped
    init: true
    read_only: false
    entrypoint: /entrypoint.sh
    environment:
      - API_URL=http://download-api.${DOMAIN:-localhost}/
      - WEB_API_URL=http://download-api.${DOMAIN:-localhost}/
    volumes:
      - ./cobalt/entrypoint.sh:/entrypoint.sh:ro
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "com.centurylinklabs.watchtower.enable=true"
      - "traefik.http.routers.cobalt-web.rule=Host(`download.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.cobalt-web.entrypoints=web"
      - "traefik.http.routers.cobalt-web.service=cobalt-web"
      - "traefik.http.routers.cobalt-web-secure.rule=Host(`download.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.cobalt-web-secure.entrypoints=websecure"
      - "traefik.http.routers.cobalt-web-secure.tls=true"
      - "traefik.http.routers.cobalt-web-secure.service=cobalt-web"
      - "traefik.http.services.cobalt-web.loadbalancer.server.port=9001"
      - "traefik.http.routers.cobalt-api.rule=Host(`download-api.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.cobalt-api.entrypoints=web"
      - "traefik.http.routers.cobalt-api.service=cobalt-api"
      - "traefik.http.routers.cobalt-api-secure.rule=Host(`download-api.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.cobalt-api-secure.entrypoints=websecure"
      - "traefik.http.routers.cobalt-api-secure.tls=true"
      - "traefik.http.routers.cobalt-api-secure.service=cobalt-api"
      - "traefik.http.services.cobalt-api.loadbalancer.server.port=9000"

  # Copyparty - File Server with Web UI
  copyparty:
    image: copyparty/copyparty:latest
    container_name: copyparty
    restart: unless-stopped
    environment:
      - TZ=${TZ:-Europe/Madrid}
    volumes:
      - ./copyparty/config:/cfg
      - ${DATA_ROOT:-./data}:/data
    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "com.centurylinklabs.watchtower.enable=true"
      - "traefik.http.routers.copyparty.rule=Host(`files.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.copyparty.entrypoints=web"
      - "traefik.http.routers.copyparty-secure.rule=Host(`files.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.copyparty-secure.entrypoints=websecure"
      - "traefik.http.routers.copyparty-secure.tls=true"
      - "traefik.http.services.copyparty.loadbalancer.server.port=3923"
